// Generated by CoffeeScript 1.8.0
(function() {
  var RipdRegistry, RipdService, StormData, StormRegistry,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  StormRegistry = require('stormregistry');

  StormData = require('stormdata');

  RipdService = require('./ripd-service');

  RipdRegistry = (function(_super) {
    __extends(RipdRegistry, _super);

    function RipdRegistry(filename) {
      this.on('load', function(key, val) {
        var entry;
        console.log("restoring " + key + " with:", val);
        entry = new RipdService(key, val);
        if (entry != null) {
          entry.saved = true;
          return this.add(entry);
        }
      });
      this.on('removed', function(entry) {
        if (entry.destructor != null) {
          return entry.destructor();
        }
      });
      RipdRegistry.__super__.constructor.call(this, filename);
    }

    RipdRegistry.prototype.add = function(service) {
      var entry;
      if (!(service instanceof RipdService)) {
        return;
      }
      entry = RipdRegistry.__super__.add.call(this, service.id, service);
      return entry.on("running", (function(_this) {
        return function(instance) {
          if (entry.instance !== instance) {
            entry.instance = instance;
            return _this.update(entry);
          }
        };
      })(this));
    };

    RipdRegistry.prototype.update = function(service) {
      service.data.instance = service.instance;
      RipdRegistry.__super__.update.call(this, service.id, service);
      return delete service.data.instance;
    };

    RipdRegistry.prototype.get = function(key) {
      var entry;
      entry = RipdRegistry.__super__.get.call(this, key);
      if (entry == null) {
        return;
      }
      if ((entry.data != null) && entry.data instanceof RipdService) {
        entry.data.id = entry.id;
        return entry.data;
      } else {
        return entry;
      }
    };

    return RipdRegistry;

  })(StormRegistry);

  module.exports = RipdRegistry;

}).call(this);
